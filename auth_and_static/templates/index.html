<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script type="application/javascript" src="https://unpkg.com/react@16.0.0/umd/react.production.min.js"></script>
    <script type="application/javascript" src="https://unpkg.com/react-dom@16.0.0/umd/react-dom.production.min.js"></script>
    <script type="application/javascript" src="https://unpkg.com/babel-standalone@6.26.0/babel.js"></script>

    <title>Tasks</title>
</head>
<body>

<h1>Tasks</h1>

<p>{{ user_name }} previous tasks</p>

<form action="{% url 'auth_and_static:index' %}"  method="post">
    {% csrf_token %}
    <input type="submit" name="exit" value="exit">
</form>

<form id="new_task_old"  method="post" hidden>
    <div id="django_scrf_token">
        {% csrf_token %}
    </div>
</form>

<div id="root">

</div>

<script type="text/babel">
const rootElement = document.getElementById('root');

var epoch = 0;

class ListElemet extends React.Component{
    constructor(props){
        super(props);
        this.state = {
            num:epoch,
            error: null,
            isLoaded: false,
            items: []
        };
    }

    componentDidMount() {
        var base = this;
        (function worker() {
            if (base.state.num == epoch) {
                console.log("send ajax");
                $.ajax({
                    url: "api/task/",
                    // dataType: "json", // Для использования JSON формата получаемых данных
                    method: "GET", // Что бы воспользоваться POST методом, меняем данную строку на POST
                    //data: {"id_product": id_product,"qty_product": qty_product},
                    success: function (data) {
                        if (data.status === "ok") {
                            base.setState({
                                isLoaded: true,
                                items: data.tasks
                            });
                        } else {
                            base.setState({
                                isLoaded: true,
                                error: result.message
                            });
                        }
                    },
                    error: function (jqxhr, status, errorMsg) {
                        base.setState({
                            isLoaded: true,
                            error: errorMsg
                        });
                        console.log("error");
                        console.log(errorMsg); // Возвращаемые данные выводим в консоль
                    },
                    complete: function () {
                        // Schedule the next request when the current one's complete
                        setTimeout(worker, 5000);
                    }
                });
            }
        })();
    }

    render() {
        const { error, isLoaded, items } = this.state;
        if (!isLoaded){
            return <div>Загрузка...</div>;
        }
        else{
            return (
                <table id="task_list">
                    <tr><td>имя</td><td>состояние</td></tr>
                    {items.map(item => (
                        <tr key={item.id}>
                            <td>
                                <a onClick={() => this.props.parent.toTask(item.id)}>
                                    {item.name}
                                </a>
                            </td>
                            <td>{item.state} </td>
                        </tr>
                    ))}
                </table>
            );
        }
    }
}

class TextElemet extends React.Component{
    constructor(props) {
        super(props);
        this.state = {value: ''};
        this.handleChange = this.handleChange.bind(this);
    }

    handleChange(event) {
        this.setState({value: event.target.value});
    }

    render() {
        return (
            <input type="text" name={this.props.name} value={this.state.value} onChange={this.handleChange}/>
        );
    }
}

class ParmersElement extends React.Component{
    constructor(props){
        super(props);
        this.state = {
            num:epoch,
            error: null,
            isLoaded: false,
            descr: null
        };
    }

    render() {
        let file;
        if(this.props.args.need_file){
            file = "тут будет файл";
        }
        return (
            <div>
                {this.props.args.params.map((elem) => <span>{elem.name}<TextElemet name={elem.name}/></span>)}
                {file}
                {this.props.args.name}
            </div>
        );
    }
}

class AdditionParamsElement extends React.Component{
    constructor(props){
        super(props);
        this.state = {
            num:epoch,
            error: null,
            isLoaded: false,
            descr: null
        };
    }

    render() {
        let file;
        if(this.props.args.need_file){
            file = "тут будет файл";
        }
        return (
            <div>
                {this.props.args.params.map((elem) => <span>{elem.name}<TextElemet /></span>)}
                {file}
                {this.props.args.name}
            </div>
        );
    }
}

class CreateElemet extends React.Component{
    constructor(props){
        super(props);
        this.state = {
            num:epoch,
            error: null,
            isLoaded: false,
            descr: null,
            value: null
        };
    }

    componentDidMount() {
        var base = this;
        (function worker() {
            if(base.state.num == epoch){
                $.ajax({
                    url: "params/",
                    // dataType: "json", // Для использования JSON формата получаемых данных
                    method: "GET", // Что бы воспользоваться POST методом, меняем данную строку на POST
                    //data: {"id_product": id_product,"qty_product": qty_product},
                    success: function (data) {
                        base.setState({
                            isLoaded: true,
                            descr: data.params,
                            value:data.params[0].name
                        });
                    },
                    error: function (jqxhr, status, errorMsg) {
                        base.setState({
                            isLoaded: true,
                            error: errorMsg
                        });
                        console.log("error");
                        console.log(errorMsg); // Возвращаемые данные выводим в консоль
                    },
                });
            }
        })();
    }

    handleSubmit(event){
        var data = $('#new_task').serializeArray().reduce(function(obj, item) {
            obj[item.name] = item.value;
            return obj;
        }, {});
        // csrfmiddlewaretoken
        $('#new_task_old').serializeArray().forEach(function(item) {
            if(item.name == "csrfmiddlewaretoken")
                data[item.name] = item.value;
        });

        var base = this;
        $.ajax({
            url: "api/task/",
            dataType: "json", // Для использования JSON формата получаемых данных
       	    method: "POST", // Что бы воспользоваться POST методом, меняем данную строку на POST
    	    data: data,
       	    success: function(data) {
                base.props.parent.toList();
            },
            error: function(jqxhr, status, errorMsg) {
                console.log("error");
                console.log(errorMsg); // Возвращаемые данные выводим в консоль
            }
        });
        event.preventDefault();
    }

    handleChange(event) {
        var vbase = this;
        vbase.setState({value: event.target.value});
    }

    render() {
        const { error, isLoaded, descr } = this.state;
        if (!isLoaded){
            return <div>Загрузка...</div>;
        }
        else{
            var loc_data = null;
            descr.forEach((elem) => {
                if(elem.name == this.state.value)
                    loc_data = elem;
            });
            return (
                <div>
                    <form id="new_task" onSubmit={(event) => this.handleSubmit(event)}>
                        <select value={this.state.value} name="task_type" onChange={(event) => this.handleChange(event)}>
                            {descr.map(elem => <option value={elem.name}>{elem.name}</option>)}
                        </select>
                        <ParmersElement args={loc_data.main_params}/>
                        <div id="special_params">

                        </div>
                        <input type="submit"/>
                  </form>
              </div>
            );
        }
    }
}

class TaskElemet extends React.Component{
    constructor(props){
        super(props);
        this.state = {
            num:epoch,
            error: null,
            isLoaded: false,
            info: null,
            params: null,
            result: null
        };
    }

    componentDidMount() {
        var base = this;
        (function worker() {
            if (base.state.num == epoch) {
                $.ajax({
                    url: "api/task/",
                    dataType: "json", // Для использования JSON формата получаемых данных
                    method: "GET", // Что бы воспользоваться POST методом, меняем данную строку на POST
                    data: {
                        "id": base.props.value,
                    },
                    success: function (data) {
                        base.setState({
                            isLoaded: true,
                            info: data.info,
                            params: data.params,
                            result: data.result,
                        });
                    },
                    error: function (jqxhr, status, errorMsg) {
                        base.setState({
                            isLoaded: true,
                            error: errorMsg
                        });
                        console.log("error");
                        console.log(errorMsg); // Возвращаемые данные выводим в консоль
                        setTimeout(worker, 5000);
                    },
                });
            }
        })();
    }

    render() {
        if(this.state.isLoaded){
            if(this.state.error){
                return (
                    <div id="res">
                       возникла ошибка мы пытаемся их решить
                    </div>
                );
            }
            else {
                return (
                    <div id="res">
                       следующая информаиця:
                        <table id="task_list">
                            <tr><td>параметр</td><td>значение</td></tr>
                            {Object.keys(this.state.info).map((key, index) => (
                                <tr>
                                    <td>{key}</td><td>{this.state.info[key]} </td>
                                </tr>
                            ))}
                        </table>
                    </div>
                );
            }
        }
        else{
            return (
                <span>
                    Загружаем дополнительную информацию
                </span>
            );
        }
    }
}

class MainElement extends React.Component {
    constructor(props) {
        super(props);
        //action: 1 - list, 2 - create, 3 - task
        this.state = {
            action: 1,
            task_id: null
        };
    }

    toList(){
        ++epoch;
        this.setState({
            action: 1,
            task_id: null,
        })
    }

    toCreate(){
        ++epoch;
        this.setState({
            action: 2,
            task_id: null,
        })
    }

    toTask(id){
        ++epoch;
        this.setState({
            action: 3,
            task_id: id,
        })
    }

    render() {
        if(this.state.action == 1) {
            return (
                <div id="main_tasks">
                    <a onClick={() => this.toCreate()}> новая задача </a>
                    <ListElemet parent={this}/>
                </div>
            );
        }
        else if(this.state.action == 2){
            return (
                <div id="main_tasks">
                    <a onClick={() => this.toList()}> назад </a>
                    <CreateElemet  parent={this}/>
                </div>
            );
        }
        else if(this.state.action == 3){
            return (
                <div id="main_tasks">
                    <a onClick={() => this.toList()}> назад </a>
                    <TaskElemet value={this.state.task_id}/>
                </div>
            );
        }
    }
}

function App(){
  return(
      <MainElement title="React Stranger Things"/>
  )
}

ReactDOM.render(
    <App />,
    rootElement
)
</script>

</body>
</html>